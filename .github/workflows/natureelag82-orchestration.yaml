name: "Deploy Now: Orchestration"
run-name: "Deploy Now: Build natureelag82 - ${{ github.event.head_commit.message || format('Triggered by {0}', github.triggering_actor) }}"

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  retrieve-project:
    name: check readiness
    runs-on: ubuntu-latest
    outputs:
      deployment-enabled: ${{ steps.project-meta.outputs.deployment-enabled }}
      branch-id: ${{ steps.project-meta.outputs.branch-id }}
    steps:
      - name: Validate IONOS configuration
        shell: bash
        env:
          IONOS_API_KEY: ${{ secrets.IONOS_API_KEY }}
          IONOS_SSH_KEY: ${{ secrets.IONOS_SSH_KEY }}
          IONOS_PROJECT_ID: ${{ secrets.IONOS_PROJECT_ID || vars.IONOS_PROJECT_ID }}
        run: |
          set -euo pipefail

          missing=0
          if [ -z "${IONOS_API_KEY}" ]; then
            echo "::error::Missing IONOS_API_KEY. Configure IONOS_API_KEY as a repository secret."
            missing=1
          fi

          if [ -z "${IONOS_SSH_KEY}" ]; then
            echo "::error::Missing IONOS_SSH_KEY. Configure IONOS_SSH_KEY as a repository secret."
            missing=1
          fi

          if [ -z "${IONOS_PROJECT_ID}" ]; then
            echo "::error::Missing IONOS_PROJECT_ID. Configure IONOS_PROJECT_ID as a repository variable (or secret)."
            missing=1
          fi

          if [ "${missing}" -ne 0 ]; then
            exit 1
          fi

      - name: Fetch project data
        uses: ionos-deploy-now/project-action@v1
        id: project
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: ${{ secrets.IONOS_PROJECT_ID || vars.IONOS_PROJECT_ID }}
          action: retrieve-info

      - name: Extract project metadata
        id: project-meta
        shell: bash
        run: |
          set -euo pipefail

          INFO='${{ steps.project.outputs.info }}'
          if [ -z "${INFO}" ]; then
            echo "deployment-enabled=false" >> "${GITHUB_OUTPUT}"
            echo "branch-id=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          DEPLOYMENT_ENABLED=$(echo "${INFO}" | jq -r '.["deployment-enabled"] // .deployment_enabled // "false"')
          BRANCH_ID=$(echo "${INFO}" | jq -r '.["branch-id"] // .branch_id // ""')

          echo "deployment-enabled=${DEPLOYMENT_ENABLED}" >> "${GITHUB_OUTPUT}"
          echo "branch-id=${BRANCH_ID}" >> "${GITHUB_OUTPUT}"

  build:
    name: build
    needs: retrieve-project
    if: ${{ needs.retrieve-project.outputs.deployment-enabled == 'true' }}
    uses: ./.github/workflows/natureelag82-build.yaml
    with:
      site-url: https://IONOS_DEPLOY_NOW_SITE_URL
      branch-id: ${{ needs.retrieve-project.outputs.branch-id }}
    secrets: inherit

  deploy:
    name: trigger deployment
    needs:
      - retrieve-project
      - build
    if: ${{ needs.retrieve-project.outputs.deployment-enabled == 'true' && needs.build.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch deployment(s)
        uses: ionos-deploy-now/project-action@v1
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: ${{ secrets.IONOS_PROJECT_ID || vars.IONOS_PROJECT_ID }}
          branch-id: ${{ needs.retrieve-project.outputs.branch-id }}
          action: dispatch-deployments
